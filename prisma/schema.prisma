// SGA 私有化部署 Prisma Schema
// 支持管理员设置公司信息、Agent管理、用户权限管理

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 公司信息表
model Company {
  id        String   @id @default(cuid())
  name      String   @unique
  logoUrl   String?  @map("logo_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // 关联
  departments Department[]
  agents      Agent[]
  users       User[]

  @@map("companies")
}

// 部门表（单层结构）
model Department {
  id          String   @id @default(cuid())
  companyId   String   @map("company_id")
  name        String
  description String?
  icon        String?  // 图标名称
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // 关联
  company     Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  agents      Agent[]
  users       User[]

  @@unique([companyId, name], name: "companyId_name")
  @@map("departments")
}

// 用户表
model User {
  id           String    @id @default(cuid())
  companyId    String    @map("company_id")
  username     String    @map("username")     // 登录用户名
  userId       String    @map("user_id")      // 企微UserID/Dify访问ID
  phone        String                         // 手机号
  passwordHash String    @map("password_hash") // 密码哈希
  chineseName  String    @map("chinese_name") // 中文姓名
  englishName  String?   @map("english_name") // 英文姓名
  email        String?                        // 邮箱
  displayName  String?   @map("display_name") // 显示名称（兼容字段）
  avatarUrl    String?   @map("avatar_url")
  departmentId String?   @map("department_id") // 部门ID
  position     String?                        // 职位
  role         UserRole  @default(USER)
  isActive     Boolean   @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // 关联
  company           Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  department        Department?         @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  agentPermissions  UserAgentPermission[]
  sessions          ChatSession[]
  messages          ChatMessage[]
  uploadedFiles     UploadedFile[]

  @@unique([companyId, username], name: "unique_username")
  @@unique([companyId, userId], name: "unique_user_id")
  @@unique([companyId, phone], name: "unique_phone")
  @@map("users")
}

// 用户角色枚举
enum UserRole {
  ADMIN
  USER
}

// Agent平台类型枚举
enum AgentPlatform {
  DIFY
  RAGFLOW
  HIAGENT
  OPENAI
  CLAUDE
  CUSTOM
}

// Agent表
model Agent {
  id                  String        @id @default(cuid())
  companyId           String        @map("company_id")
  departmentId        String        @map("department_id")
  chineseName         String        @map("chinese_name")
  englishName         String?       @map("english_name")
  position            String
  description         String?
  avatarUrl           String?       @map("avatar_url")    // 聊天界面头像
  photoUrl            String?       @map("photo_url")     // 主页展示照片

  // 平台配置
  platform            AgentPlatform @default(DIFY)
  platformConfig      Json?         @map("platform_config") // 存储各平台的配置参数

  // 兼容性字段（逐步迁移）
  difyUrl             String?       @map("dify_url")
  difyKey             String?       @map("dify_key")

  // 状态字段
  isOnline            Boolean       @default(false) @map("is_online")
  connectionTestedAt  DateTime?     @map("connection_tested_at")
  lastError           String?       @map("last_error")
  sortOrder           Int           @default(0) @map("sort_order")
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")

  // 关联
  company             Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  department          Department          @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  userPermissions     UserAgentPermission[]
  sessions            ChatSession[]

  @@map("agents")
}

// 用户Agent权限表
model UserAgentPermission {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  agentId   String   @map("agent_id")
  grantedBy String   @map("granted_by")  // 授权管理员ID
  createdAt DateTime @default(now()) @map("created_at")

  // 关联
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([userId, agentId], name: "unique_user_agent")
  @@map("user_agent_permissions")
}

// 聊天会话表
model ChatSession {
  id             String        @id @default(cuid())
  userId         String        @map("user_id")
  agentId        String        @map("agent_id")
  sessionName    String?       @map("session_name")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  // 关联
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  agent          Agent         @relation(fields: [agentId], references: [id], onDelete: Cascade)
  messages       ChatMessage[]

  @@map("chat_sessions")
}

// 聊天消息表
model ChatMessage {
  id        String      @id @default(cuid())
  sessionId String      @map("session_id")
  userId    String      @map("user_id")
  role      MessageRole
  content   String
  metadata  Json?       // 额外信息
  createdAt DateTime    @default(now()) @map("created_at")

  // 关联
  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}

// 消息角色枚举
enum MessageRole {
  USER
  ASSISTANT
}

// 上传文件表
model UploadedFile {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  fileName  String   @map("file_name")
  filePath  String   @map("file_path")
  fileUrl   String   @map("file_url")
  fileSize  Int      @map("file_size")
  fileType  String   @map("file_type")
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  // 关联
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("uploaded_files")
}
