generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id              String           @id @default(cuid())
  name            String           @unique
  logoUrl         String?          @map("logo_url")
  mdmConfig       Json?            @map("mdm_config")
  mdmToken        String?          @map("mdm_token")
  mdmSyncEnabled  Boolean          @default(false) @map("mdm_sync_enabled")
  mdmSyncIntervalMin Int?          @map("mdm_sync_interval_min")
  mdmLastSyncAt   DateTime?        @map("mdm_last_sync_at")
  mdmLastSyncStatus String?        @map("mdm_last_sync_status")
  mdmLastSyncError String?         @map("mdm_last_sync_error")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  agents          Agent[]
  departments     Department[]
  departmentSyncLogs DepartmentSyncLog[]
  knowledgeGraphs KnowledgeGraph[]
  users           User[]

  @@map("companies")
}

model Department {
  id          String   @id @default(cuid())
  companyId   String   @map("company_id")
  name        String
  description String?
  icon        String?
  sortOrder   Int      @default(0) @map("sort_order")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  parentId    String?  @map("parent_id")
  parent      Department?  @relation("DepartmentTree", fields: [parentId], references: [id], onDelete: SetNull)
  children    Department[] @relation("DepartmentTree")
  source      DepartmentSource @default(LOCAL)
  mdmExternalId       String?   @map("mdm_external_id")
  mdmParentExternalId String?   @map("mdm_parent_external_id")
  mdmCode             String?   @map("mdm_code")
  mdmLcode            String?   @map("mdm_lcode")
  mdmLname            String?   @map("mdm_lname")
  mdmIdx              Int?      @map("mdm_idx")
  mdmIsUsed           Boolean?  @map("mdm_is_used")
  mdmPayload          Json?     @map("mdm_payload")
  mdmSyncedAt         DateTime? @map("mdm_synced_at")
  mdmDeletedAt        DateTime? @map("mdm_deleted_at")
  agents      Agent[]
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  users       User[]

  @@unique([companyId, name], name: "companyId_name")
  @@unique([companyId, mdmExternalId], name: "unique_company_mdm_external_id")
  @@index([companyId, parentId])
  @@index([companyId, mdmLcode])
  @@map("departments")
}

model User {
  id               String                @id @default(cuid())
  companyId        String                @map("company_id")
  username         String                @map("username")
  userId           String                @default("") @map("user_id")
  phone            String                @default("")
  passwordHash     String                @map("password_hash")
  chineseName      String                @default("") @map("chinese_name")
  englishName      String?               @map("english_name")
  email            String?
  displayName      String?               @map("display_name")
  avatarUrl        String?               @map("avatar_url")
  departmentId     String?               @map("department_id")
  mdmDepartmentExternalId String?        @map("mdm_department_external_id")
  localDepartmentOverride String?        @map("local_department_override")
  localDeptOverrideReason String?        @map("local_dept_override_reason")
  localDeptOverrideAt     DateTime?      @map("local_dept_override_at")
  localDeptOverrideBy     String?        @map("local_dept_override_by")
  position         String?
  role             UserRole              @default(USER)
  isActive         Boolean               @default(true) @map("is_active")
  lastLoginAt      DateTime?             @map("last_login_at")
  createdAt        DateTime              @default(now()) @map("created_at")
  updatedAt        DateTime              @updatedAt @map("updated_at")
  messages                      ChatMessage[]
  sessions                      ChatSession[]
  uploadedFiles                 UploadedFile[]
  agentPermissions              UserAgentPermission[]
  agentPermissionRevocations    UserAgentPermissionRevocation[]
  knowledgeGraphPermissions     UserKnowledgeGraphPermission[]
  tempKnowledgeBase             UserTempKnowledgeBase?
  company                       Company                       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  department                    Department?                   @relation(fields: [departmentId], references: [id])

  @@unique([companyId, username], name: "unique_username")
  @@unique([companyId, userId], name: "unique_user_id")
  @@unique([companyId, phone], name: "unique_phone")
  @@map("users")
}

model Agent {
  id                 String                @id @default(cuid())
  companyId          String                @map("company_id")
  departmentId       String                @map("department_id")
  chineseName        String                @map("chinese_name")
  englishName        String?               @map("english_name")
  position           String
  description        String?
  avatarUrl          String?               @map("avatar_url")
  photoUrl           String?               @map("photo_url")
  platform           AgentPlatform         @default(DIFY)
  platformConfig     Json?                 @map("platform_config")
  difyUrl            String?               @map("dify_url")
  difyKey            String?               @map("dify_key")
  isOnline           Boolean               @default(false) @map("is_online")
  connectionTestedAt DateTime?             @map("connection_tested_at")
  lastError          String?               @map("last_error")
  sortOrder          Int                   @default(0) @map("sort_order")
  createdAt          DateTime              @default(now()) @map("created_at")
  updatedAt          DateTime              @updatedAt @map("updated_at")
  company            Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  department         Department            @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  sessions           ChatSession[]
  userPermissions    UserAgentPermission[]
  userPermissionRevocations UserAgentPermissionRevocation[]

  @@map("agents")
}

model UserAgentPermission {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  agentId   String   @map("agent_id")
  grantedBy String   @map("granted_by")
  grantedVia String? @map("granted_via")
  grantBatchId String? @map("grant_batch_id")
  createdAt DateTime @default(now()) @map("created_at")
  agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, agentId], name: "unique_user_agent")
  @@map("user_agent_permissions")
}

model UserAgentPermissionRevocation {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  agentId   String   @map("agent_id")
  revokedBy String   @map("revoked_by")
  revokedAt DateTime @default(now()) @map("revoked_at")
  reason    String?
  isActive  Boolean  @default(true) @map("is_active")
  expiresAt DateTime? @map("expires_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([userId, agentId], name: "unique_user_agent_revocation")
  @@index([agentId, isActive])
  @@map("user_agent_permission_revocations")
}

model DepartmentSyncLog {
  id            String   @id @default(cuid())
  companyId     String   @map("company_id")
  triggeredBy   String   @map("triggered_by")
  triggerType   String   @map("trigger_type")
  startedAt     DateTime @map("started_at")
  finishedAt    DateTime? @map("finished_at")
  durationMs    Int?     @map("duration_ms")
  totalExpected Int?     @map("total_expected")
  totalPulled   Int?     @map("total_pulled")
  pageCount     Int?     @map("page_count")
  created       Int      @default(0)
  updated       Int      @default(0)
  deactivated   Int      @default(0)
  status        String   @default("running")
  errorMessage  String?  @map("error_message")
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, startedAt])
  @@map("department_sync_logs")
}

model UserKnowledgeGraphPermission {
  id                String         @id @default(cuid())
  userId            String         @map("user_id")
  knowledgeGraphId  String         @map("knowledge_graph_id")
  grantedBy         String         @map("granted_by")
  createdAt         DateTime       @default(now()) @map("created_at")
  knowledgeGraph    KnowledgeGraph @relation(fields: [knowledgeGraphId], references: [id], onDelete: Cascade)
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, knowledgeGraphId], name: "userId_knowledgeGraphId")
  @@map("user_knowledge_graph_permissions")
}

model ChatSession {
  id          String        @id @default(cuid())
  userId      String        @map("user_id")
  agentId     String        @map("agent_id")
  sessionName String?       @map("session_name")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  messages    ChatMessage[]
  agent       Agent         @relation(fields: [agentId], references: [id], onDelete: Cascade)
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("chat_sessions")
}

model ChatMessage {
  id        String      @id @default(cuid())
  sessionId String      @map("session_id")
  userId    String      @map("user_id")
  role      MessageRole
  content   String
  metadata  Json?
  createdAt DateTime    @default(now()) @map("created_at")
  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}

model UploadedFile {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  fileName  String   @map("file_name")
  filePath  String   @map("file_path")
  fileUrl   String   @map("file_url")
  fileSize  Int      @map("file_size")
  fileType  String   @map("file_type")
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("uploaded_files")
}

model KnowledgeGraph {
  id          String    @id @default(cuid())
  companyId   String    @map("company_id")
  name        String
  description String?
  ragflowUrl  String    @map("ragflow_url")
  apiKey      String    @map("api_key")
  kbId        String    @map("kb_id")
  isActive    Boolean   @default(true) @map("is_active")
  lastSyncAt  DateTime? @map("last_sync_at")
  lastError   String?   @map("last_error")
  nodeCount   Int       @default(0) @map("node_count")
  edgeCount   Int       @default(0) @map("edge_count")
  sortOrder   Int       @default(0) @map("sort_order")
  createdAt         DateTime                       @default(now()) @map("created_at")
  updatedAt         DateTime                       @updatedAt @map("updated_at")
  company           Company                        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  userPermissions   UserKnowledgeGraphPermission[]

  @@unique([companyId, name], name: "companyId_name")
  @@map("knowledge_graphs")
}

enum UserRole {
  ADMIN
  USER
}

enum DepartmentSource {
  LOCAL
  MDM
}

enum AgentPlatform {
  DIFY
  RAGFLOW
  HIAGENT
  OPENAI
  CLAUDE
  CUSTOM
}

enum MessageRole {
  USER
  ASSISTANT
}

// ============================================
// 临时知识图谱相关模型
// ============================================

/// 用户临时知识库 - 存储用户在聊天过程中保存的知识片段
model UserTempKnowledgeBase {
  id              String    @id @default(cuid())
  userId          String    @unique @map("user_id")
  ragflowKbId     String    @map("ragflow_kb_id")      // RAGFlow dataset ID
  ragflowDocId    String?   @map("ragflow_doc_id")     // RAGFlow 虚拟文档ID
  ragflowUrl      String    @map("ragflow_url")        // RAGFlow 服务地址
  apiKey          String    @map("api_key")            // RAGFlow API Key
  sessionId       String?   @map("session_id")         // 关联的聊天会话ID
  chunkCount      Int       @default(0) @map("chunk_count")
  nodeCount       Int       @default(0) @map("node_count")   // 图谱节点数
  edgeCount       Int       @default(0) @map("edge_count")   // 图谱边数
  status          TempKbStatus @default(ACTIVE)        // 状态
  isPersistent    Boolean   @default(false) @map("is_persistent")
  lastActiveAt    DateTime  @default(now()) @map("last_active_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  expiresAt       DateTime? @map("expires_at")         // 过期时间

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  savedChunks     UserSavedChunk[]

  @@map("user_temp_knowledge_bases")
}

/// 用户保存的知识片段记录
model UserSavedChunk {
  id              String    @id @default(cuid())
  tempKbId        String    @map("temp_kb_id")
  ragflowChunkId  String?   @map("ragflow_chunk_id")   // RAGFlow chunk ID
  content         String    @db.Text                    // 内容
  contentSummary  String?   @map("content_summary")     // 内容摘要
  keywords        String[]                              // 关键词
  sourceMessageId String?   @map("source_message_id")  // 来源消息ID
  sourceType      String?   @map("source_type")        // 来源类型: assistant_reply, reference, user_input
  createdAt       DateTime  @default(now()) @map("created_at")

  tempKb          UserTempKnowledgeBase @relation(fields: [tempKbId], references: [id], onDelete: Cascade)

  @@index([tempKbId])
  @@map("user_saved_chunks")
}

/// 临时知识库状态枚举
enum TempKbStatus {
  ACTIVE          // 活跃中
  BUILDING        // 图谱构建中
  EXPIRED         // 已过期
  PERSISTENT      // 已持久化
}
