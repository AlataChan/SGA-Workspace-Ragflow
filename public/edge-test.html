<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edge浏览器兼容性测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-item {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #ccc;
        }
        .test-item.pass {
            border-left-color: #4CAF50;
        }
        .test-item.fail {
            border-left-color: #f44336;
        }
        .test-button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #005a9e;
        }
        .error-log {
            background: #ffebee;
            border: 1px solid #ffcdd2;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>Edge浏览器兼容性测试</h1>
    <p>请在Edge浏览器中打开此页面，点击下面的测试按钮来检查兼容性问题。</p>
    
    <div id="browser-info" class="test-item">
        <h3>浏览器信息</h3>
        <p id="user-agent"></p>
        <p id="browser-version"></p>
    </div>

    <div id="api-tests">
        <h2>API兼容性测试</h2>
        
        <div id="fetch-test" class="test-item">
            <h3>Fetch API 测试</h3>
            <button class="test-button" onclick="testFetch()">测试 Fetch API</button>
            <div id="fetch-result"></div>
        </div>

        <div id="agent-api-test" class="test-item">
            <h3>Agent API 测试</h3>
            <button class="test-button" onclick="testAgentAPI()">测试 Agent API</button>
            <div id="agent-api-result"></div>
        </div>

        <div id="create-test" class="test-item">
            <h3>创建Agent测试</h3>
            <button class="test-button" onclick="testCreateAgent()">测试创建Agent</button>
            <div id="create-result"></div>
        </div>
    </div>

    <div id="error-log" class="error-log" style="display: none;">
        <h3>错误日志</h3>
        <div id="error-content"></div>
    </div>

    <script>
        // 显示浏览器信息
        document.getElementById('user-agent').textContent = 'User Agent: ' + navigator.userAgent;
        
        // 检测Edge版本
        const isEdge = navigator.userAgent.indexOf('Edge') !== -1 || navigator.userAgent.indexOf('Edg') !== -1;
        const edgeVersion = navigator.userAgent.match(/Edge\/(\d+)/) || navigator.userAgent.match(/Edg\/(\d+)/);
        document.getElementById('browser-version').textContent = isEdge ? 
            `Edge 版本: ${edgeVersion ? edgeVersion[1] : '未知'}` : 
            '当前不是Edge浏览器';

        // 错误日志
        const errorLog = [];
        function logError(test, error) {
            errorLog.push(`[${test}] ${error}`);
            const errorDiv = document.getElementById('error-log');
            const errorContent = document.getElementById('error-content');
            errorContent.textContent = errorLog.join('\n');
            errorDiv.style.display = 'block';
        }

        // 测试结果显示
        function showResult(testId, success, message) {
            const element = document.getElementById(testId);
            const resultDiv = element.querySelector('div[id$="-result"]');
            element.className = 'test-item ' + (success ? 'pass' : 'fail');
            resultDiv.innerHTML = `<p><strong>${success ? '✅ 通过' : '❌ 失败'}</strong>: ${message}</p>`;
        }

        // 测试 Fetch API
        function testFetch() {
            try {
                if (typeof fetch === 'undefined') {
                    showResult('fetch-test', false, 'Fetch API 不支持');
                    logError('Fetch', 'Fetch API 不支持');
                    return;
                }
                
                fetch('data:text/plain,test')
                    .then(response => response.text())
                    .then(data => {
                        showResult('fetch-test', true, 'Fetch API 工作正常');
                    })
                    .catch(error => {
                        showResult('fetch-test', false, 'Fetch API 错误: ' + error.message);
                        logError('Fetch', error.message);
                    });
            } catch (error) {
                showResult('fetch-test', false, 'Fetch API 异常: ' + error.message);
                logError('Fetch', error.message);
            }
        }

        // 测试 Agent API
        async function testAgentAPI() {
            try {
                const response = await fetch('/api/admin/agents');
                if (response.ok) {
                    const data = await response.json();
                    showResult('agent-api-test', true, 'Agent API 连接成功，返回 ' + (data.data ? data.data.length : 0) + ' 个Agent');
                } else {
                    showResult('agent-api-test', false, 'Agent API 响应错误: ' + response.status);
                    logError('Agent API', 'Agent API 响应错误: ' + response.status);
                }
            } catch (error) {
                showResult('agent-api-test', false, 'Agent API 异常: ' + error.message);
                logError('Agent API', error.message);
            }
        }

        // 测试创建Agent
        async function testCreateAgent() {
            try {
                const testData = {
                    departmentId: 'dept_management',
                    chineseName: 'Edge测试Agent',
                    englishName: 'Edge Test Agent',
                    position: 'Edge测试专员',
                    description: '用于测试Edge兼容性',
                    platform: 'DIFY',
                    platformConfig: {
                        baseUrl: 'https://api.dify.ai/v1',
                        apiKey: 'app-edgetest123456'
                    },
                    sortOrder: 999
                };

                console.log('发送创建请求:', testData);
                
                const response = await fetch('/api/admin/agents', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });

                console.log('响应状态:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('创建成功:', data);
                    showResult('create-test', true, '创建Agent成功: ' + data.message);
                } else {
                    const error = await response.json();
                    console.log('创建失败:', error);
                    showResult('create-test', false, '创建Agent失败: ' + (error.error && error.error.message ? error.error.message : error.message || '未知错误'));
                    logError('Create Agent', error.error && error.error.message ? error.error.message : error.message || '未知错误');
                }
            } catch (error) {
                console.log('创建异常:', error);
                showResult('create-test', false, '创建Agent异常: ' + error.message);
                logError('Create Agent', error.message);
            }
        }

        // 全局错误捕获
        window.onerror = function(message, source, lineno, colno, error) {
            logError('Global', `${message} at ${source}:${lineno}:${colno}`);
            return false;
        };

        // Promise 错误捕获
        window.addEventListener('unhandledrejection', function(event) {
            logError('Promise Rejection', event.reason);
        });
    </script>
</body>
</html>
