# 🚀 企业AI工作空间 - 轻量级架构设计

## 🎯 设计原则

**简单、可靠、够用**
- ❌ 不要过度工程化
- ❌ 不要引入不必要的复杂性  
- ✅ 专注核心AI功能
- ✅ 易于部署和维护

## 🏗️ 轻量级架构

```
┌─────────────────────────────────────────┐
│            Nginx (18000)                │
│          API网关 + 静态文件              │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│           Next.js App (18080)           │
│     SSR + API Routes + 业务逻辑         │
└─────┬─────┬─────┬─────┬─────────────────┘
      │     │     │     │
      ▼     ▼     ▼     ▼
┌─────────┐ ┌───┐ ┌───┐ ┌─────────┐
│PostgreSQL│ │Red│ │Qdr│ │MinIO    │
│简单直连  │ │is │ │ant│ │文件存储 │
│15432    │ │163│ │163│ │19000    │
└─────────┘ └───┘ └───┘ └─────────┘
```

## 🗄️ 简化数据库设计

### 核心原则
1. **单一PostgreSQL** - 不需要Supabase复杂性
2. **简单认证** - JWT + bcrypt，不需要外部认证服务
3. **直接连接** - 应用直连数据库，减少中间层
4. **最小权限** - 基于角色的简单权限控制

### 数据库架构
```sql
-- 核心表
companies (企业)
users (用户 + 认证)
ai_agents (AI智能体)
chat_sessions (聊天会话)
chat_messages (聊天消息)
knowledge_bases (知识库)
file_uploads (文件管理)

-- 辅助表
user_sessions (会话管理)
system_configs (系统配置)
audit_logs (审计日志)
```

## 🔐 简化认证系统

### 认证流程
```
1. 用户登录 → 验证密码 → 生成JWT
2. 请求验证 → 解析JWT → 检查权限
3. 会话管理 → Redis缓存 → 自动续期
```

### 权限模型
```
角色系统:
- super_admin: 系统管理员
- admin: 企业管理员  
- user: 普通用户

资源权限:
- 企业数据隔离 (company_id)
- 用户数据隔离 (user_id)
- 简单的RBAC控制
```

## 🐳 轻量Docker架构

### 服务组件 (5个容器)
```
nginx (18000)     - API网关 + 静态文件
app (18080)       - Next.js应用
postgres (15432)  - 主数据库
redis (16379)     - 缓存 + 会话
qdrant (16333)    - 向量数据库
minio (19000)     - 文件存储 (可选)
```

### 可选组件
```
prometheus (19090) - 监控 (可选)
grafana (13001)    - 仪表板 (可选)
```

## 📦 部署选项

### 选项1: 完整部署 (推荐)
```bash
# 包含所有服务
docker-compose up -d
```

### 选项2: 最小部署
```bash
# 只启动核心服务
docker-compose up -d app postgres redis qdrant
```

### 选项3: 开发模式
```bash
# 使用SQLite，更轻量
NODE_ENV=development npm run dev
```

## 🔧 技术栈简化

### 后端
- **数据库**: PostgreSQL (直连，无中间层)
- **认证**: 自定义JWT + bcrypt
- **缓存**: Redis (会话 + 限流)
- **文件**: MinIO 或本地存储
- **向量**: Qdrant (知识库)

### 前端  
- **框架**: Next.js 13+ (App Router)
- **状态**: Zustand + IndexedDB
- **UI**: 现有组件库
- **离线**: IndexedDB优先策略

## 🚀 部署优势

### 简单性
- ✅ 5个核心容器，依赖关系清晰
- ✅ 标准PostgreSQL，无特殊配置
- ✅ 一键启动，快速部署
- ✅ 易于备份和迁移

### 性能
- ✅ 直连数据库，减少延迟
- ✅ Redis缓存，提升响应速度
- ✅ 前端离线优先，用户体验好
- ✅ 资源占用少，成本低

### 维护性
- ✅ 标准技术栈，易于招聘
- ✅ 日志集中，问题定位快
- ✅ 监控可选，按需启用
- ✅ 升级简单，风险可控

## 🔄 数据流设计

### 用户认证流
```
登录 → 验证密码 → 生成JWT → 存储Redis → 返回Token
请求 → 验证JWT → 检查权限 → 处理业务 → 返回结果
```

### 聊天数据流
```
前端 → IndexedDB缓存 → API请求 → 数据库存储
AI响应 → 实时流式 → 前端显示 → 后台保存
```

### 知识库流
```
文档上传 → MinIO存储 → 文本提取 → 向量化 → Qdrant存储
用户查询 → 向量搜索 → 相关文档 → AI增强回答
```

## 📊 资源需求

### 最小配置
```
CPU: 2核
内存: 4GB
磁盘: 20GB
网络: 10Mbps
```

### 推荐配置
```
CPU: 4核
内存: 8GB  
磁盘: 50GB SSD
网络: 100Mbps
```

### 生产配置
```
CPU: 8核
内存: 16GB
磁盘: 100GB SSD
网络: 1Gbps
备份: 自动化
监控: 完整
```

## 🔒 安全考虑

### 基础安全
- ✅ JWT签名验证
- ✅ 密码bcrypt加密
- ✅ API速率限制
- ✅ 输入参数验证
- ✅ SQL注入防护

### 企业安全
- ✅ 数据隔离 (company_id)
- ✅ 角色权限控制
- ✅ 审计日志记录
- ✅ 敏感数据加密
- ✅ 定期安全扫描

### 网络安全
- ✅ HTTPS强制
- ✅ CORS配置
- ✅ 防火墙规则
- ✅ VPN访问 (可选)
- ✅ IP白名单 (可选)

## 🎯 实施计划

### 阶段1: 核心功能 (1周)
- [x] 数据库schema设计
- [ ] 基础认证系统
- [ ] 用户管理API
- [ ] 聊天功能API

### 阶段2: AI功能 (1周)  
- [ ] AI Agent集成
- [ ] 知识库功能
- [ ] 文件上传处理
- [ ] 向量搜索API

### 阶段3: 部署优化 (3天)
- [ ] Docker配置
- [ ] 环境变量管理
- [ ] 健康检查
- [ ] 日志配置

### 阶段4: 监控运维 (2天)
- [ ] 性能监控
- [ ] 错误追踪
- [ ] 备份策略
- [ ] 部署文档

这个轻量级架构去掉了Supabase的复杂性，保持了核心功能的完整性，更适合企业内部部署和维护。
