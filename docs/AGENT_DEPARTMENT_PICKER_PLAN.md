# Agent 创建/编辑：部门选择器改造方案（展示偏 C、交互偏 B）

> 目标场景：当前部门数量 1000+（示例 1632），在「新建/编辑 Agent」时选择“所属部门”使用下拉框效率较低，容易选错、难查找。

---

## 1. 结论：可行（C 的信息展示 + B 的搜索交互）

可以用一个 **“可搜索的部门选择器（Combobox）”** 作为主要交互（偏 B），同时在每个选项/已选值里展示 **“部门层级路径”** 来保证信息表达（偏 C）。

简言之：

- **交互**：像 B 一样输入搜索、回车选择、快速完成；
- **展示**：像 C 一样显示层级上下文（路径/树定位），避免同名部门选错；
- **可选增强**：提供“浏览树”作为补充入口（不强迫用户逐层展开）。

---

## 2. 目标与非目标

### 2.1 目标

- 支持搜索（输入即过滤），快速定位部门
- 支持“我的部门置顶”（当前用户所属部门）
- 支持“最近使用置顶”（提升重复操作效率）
- 选项展示带“部门路径”（例如 `总部 / 华东 / 济南营业部`），降低误选风险
- 1k～5k 部门规模下前端体验顺滑（无明显卡顿）

### 2.2 非目标（本阶段不做）

- 权限控制/可见部门裁剪（如需按角色/范围过滤，另立需求）
- 极大规模（>1 万）部门的全量前端渲染优化（可用远程搜索作为后续扩展）

---

## 3. 推荐方案（Hybrid：Search-first + Path Display）

### 3.1 UI 结构（推荐）

将“所属部门”从传统 `Select` 改为 **Combobox（Popover + 可搜索列表）**：

1) 触发器（输入框样式）
- 默认显示：`请选择部门`
- 选中后显示：`部门名称`（主标题） + `部门路径`（副标题/tooltip）

2) 弹层内容（Popover）
- 顶部：搜索输入框（支持中文）
- 中间：搜索结果列表（键盘可操作，上下选择、回车确认）
- 底部：可选的“浏览树”入口（详见 3.3）

### 3.2 搜索结果如何体现“树状信息”（满足展示偏 C）

搜索结果列表每一项展示两行：

- 第一行：部门名（例如 `济南营业部（筹）`）
- 第二行：部门路径（例如 `华东大区 / 山东省区 / 济南营业部（筹）`）

这样用户不需要展开树，也能获得层级上下文。

### 3.3 “浏览树”作为补充入口（满足少量探索型需求）

当用户不想搜索、或需要浏览结构时提供一个补充入口（不打断 Search-first）：

- 方式 A：Popover 内增加一个“浏览树”Tab/折叠面板
- 方式 B：在结果列表底部提供“打开组织树定位”按钮（跳到组织树页并高亮该部门）

推荐方式 A（同一弹层内解决）：

- 默认 Tab：搜索（最常用）
- 可切换 Tab：浏览树（树结构+展开/折叠）
- 搜索命中时：可自动展开树并定位（可选）

---

## 4. 置顶策略（“我的部门”+“最近使用”）

### 4.1 分组展示（推荐）

Popover 内容按以下顺序组织：

1) **我的部门**
- 展示 1 条：当前用户所属部门（若存在且启用）
- 支持“一键选择”

2) **最近使用**
- 展示最近 N（建议 5～10）个部门
- 数据来源：localStorage（按公司隔离 key）
- 选择部门后写入最近列表（去重、置顶）

3) **全部部门（搜索结果/浏览树）**

### 4.2 搜索时的置顶规则（推荐）

当用户输入搜索词时：

- 先展示“命中的我的部门”（若命中）
- 再展示“命中的最近使用”
- 再展示其它匹配项（按匹配度排序）

> 不建议在有搜索词时强行固定展示“我的部门”/“最近使用”不管是否命中，会干扰用户的搜索心智。

---

## 5. 数据依赖与接口建议

### 5.1 部门数据

为了展示“路径/层级”，需要拿到 `parentId` 关系：

- 推荐使用轻量树接口：`GET /api/admin/departments/tree`
  - 返回 `id/name/parentId/sortOrder/isActive/children`（不包含用户）
  - 前端可一次性构建：
    - `id -> node`
    - `id -> pathString`
    - `id -> ancestors`（可选）

### 5.2 当前用户的 departmentId（用于“我的部门置顶”）

当前前端常用的 `GET /api/auth/login`（me）返回数据里**不包含 departmentId**，因此需要一个可靠来源：

- 方案 1（推荐）：在 `GET /api/auth/login` 返回 `departmentId`（以及可选 `department.name`）
- 方案 2：新增 `GET /api/auth/me` / `GET /api/admin/me` 专门返回 `departmentId`
- 方案 3：在前端登录成功后把 departmentId 写入 localStorage（需要后端登录响应包含该字段）

> 本方案只依赖“读取 departmentId”，不改变鉴权逻辑。

---

## 6. 匹配与排序（实现建议）

### 6.1 匹配

基础版（足够）：`name.includes(query)`

增强版（更好用）：

- 支持拼音/首字母（例如输入 `jn` 能命中 `济南`）
- 支持空格分词（例如 `济南 营业`）

可选实现路径：

- 使用轻量 fuzzy 库（或 Fuse.js，但注意包体/配置）
- 只在弹层打开时构建索引，避免页面初始负担

### 6.2 排序（当 query 非空）

建议权重：

1) 是否为“我的部门”
2) 是否为“最近使用”
3) 匹配度（前缀 > 包含 > 模糊得分）
4) `sortOrder`（同分时）
5) 字符排序兜底

---

## 7. 边界与细节

- 部门停用（`isActive=false`）：在列表中置灰不可选，并提示“已停用”
- 同名部门：必须展示路径（否则很容易选错）
- 大数据量渲染：列表区域建议加 `ScrollArea`，并限制每次渲染条目（例如搜索结果最多展示 50～100 条）

---

## 8. 验收标准（建议）

- 打开“所属部门”可在 1 秒内交互（不明显卡顿）
- 输入关键字能快速过滤并高亮匹配项
- “我的部门”可置顶且一键选择
- “最近使用”可记录并置顶（跨刷新仍有效）
- 选中项展示包含“部门路径”，能区分同名部门

---

## 9. 后续扩展（可选）

- 远程搜索：当部门量 > 1 万时，改为 `/api/admin/departments?q=xx&limit=50`（debounce）
- “定位到组织树”：在组织树页面自动展开并高亮当前选中部门
- 权限裁剪：不同管理员只能看到自己范围内部门（如后续有 RBAC/数据隔离需求）

